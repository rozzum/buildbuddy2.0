"""
Start Command Handler for Professional Interior Design AI Assistant Bot
Handles the /start command and initial greeting
"""

import logging
from aiogram import Router, types
from aiogram.filters import Command
from aiogram.types import Message

from app.services.database import DatabaseService

logger = logging.getLogger(__name__)
router = Router()

@router.message(Command("start"))
async def start_command(message: Message):
    """Handle /start command with professional greeting."""
    try:
        user = message.from_user
        db_service = DatabaseService()
        
        # Get or create user session
        user_session = db_service.get_user_session(user.id)
        
        # Check if user has completed the survey
        survey_completed = user_session.get('survey_completed', False)
        
        if survey_completed:
            # User has completed survey - show personalized welcome
            welcome_text = f"""üèóÔ∏è **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user.first_name}!**

–Ø - –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –∏ –¥–∏–∑–∞–π–Ω–µ—Ä –∏–Ω—Ç–µ—Ä—å–µ—Ä–æ–≤ —Å 20+ –ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º —Ä–∞–±–æ—Ç—ã –≤ –ø—Ä–æ–µ–∫—Ç–∞—Ö –ø—Ä–µ–º–∏—É–º-–∫–ª–∞—Å—Å–∞.

‚úÖ **–í–∞—à –¥–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å –≥–æ—Ç–æ–≤!**
–¢–µ–ø–µ—Ä—å —è –∑–Ω–∞—é –≤–∞—à–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∏ –º–æ–≥—É –¥–∞–≤–∞—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –ø–æ –¥–∏–∑–∞–π–Ω—É –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞.

üöÄ **–ß—Ç–æ —è –º–æ–≥—É –¥–ª—è –≤–∞—Å —Å–¥–µ–ª–∞—Ç—å:**
‚Ä¢ –î–∞—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –ø–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–µ
‚Ä¢ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏–Ω—Ç–µ—Ä—å–µ—Ä–æ–≤
‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ —Ü–≤–µ—Ç–æ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è
‚Ä¢ –ü–æ–º–æ—á—å —Å –≤—ã–±–æ—Ä–æ–º –º–µ–±–µ–ª–∏ –∏ –¥–µ–∫–æ—Ä–∞
‚Ä¢ –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –¥–∏–∑–∞–π–Ω—É

üí° **–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞!**

üìä –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å: /status
üîÑ –°–±—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: /restart
‚ùì –°–ø—Ä–∞–≤–∫–∞: /help"""
        else:
            # User hasn't completed survey - encourage to take it
            welcome_text = f"""üèóÔ∏è **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user.first_name}!**

–Ø - –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –∏ –¥–∏–∑–∞–π–Ω–µ—Ä –∏–Ω—Ç–µ—Ä—å–µ—Ä–æ–≤ —Å 20+ –ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º —Ä–∞–±–æ—Ç—ã.

üé® **–ú–æ–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
‚Ä¢ –ê–Ω–∞–ª–∏–∑ –∏–Ω—Ç–µ—Ä—å–µ—Ä–æ–≤ –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
‚Ä¢ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–µ –∏ –¥–∏–∑–∞–π–Ω—É
‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º –∏ —Ü–≤–µ—Ç–∞–º
‚Ä¢ –°–æ–≤–µ—Ç—ã –ø–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
‚Ä¢ –û—Ç–≤–µ—Ç—ã –Ω–∞ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –¥–∏–∑–∞–π–Ω—É

üí° **–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–≤–µ—Ç–æ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –ø—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç –ø–æ –¥–∏–∑–∞–π–Ω—É –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞.**

üìä **–¢–µ—Å—Ç –≤–∫–ª—é—á–∞–µ—Ç 15 –≤–æ–ø—Ä–æ—Å–æ–≤:**
‚Ä¢ –°—Ç–∏–ª–µ–≤—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
‚Ä¢ –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è  
‚Ä¢ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
‚Ä¢ –ë—é–¥–∂–µ—Ç –∏ –≤—Ä–µ–º—è
‚Ä¢ –û–±—Ä–∞–∑ –∂–∏–∑–Ω–∏

üöÄ **–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç:** /test
üìñ **–°–ø—Ä–∞–≤–∫–∞:** /help

**–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞ –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞!**"""
        
        await message.answer(welcome_text, parse_mode="Markdown")
        
        # Store welcome message in conversation history
        db_service.add_conversation_message(user.id, welcome_text, "bot")
        
        logger.info(f"User {user.id} started the bot")
        
    except Exception as e:
        logger.error(f"Error in start command: {e}")
        await message.answer("Sorry, I encountered an error. Please try again.")
